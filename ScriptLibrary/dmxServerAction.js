/*
DMXzone Server Connect
Version: 1.1.0
(c) 2016 DMXzone.com
@build 2016-03-02 16:11:31
*/
!function(a){function b(b){return b instanceof f.Scope||(b=b instanceof Element?f.Scope.closest(b):b instanceof a?f.Scope.closest(b[0]):f.globalScope),b}function c(a,b,c){try{if(d(a))return new Function(a).apply(c,b);if("function"==typeof a)return a.apply(c,b)}catch(e){}}function d(a){return"string"==typeof a}function e(b,c){c=c||f.globalScope;var g=a.isPlainObject(b)?a.extend({},b):b;if(d(g)&&-1!=g.indexOf("{{"))return f.$parse(g,c);if("object"==typeof g)for(var h in g)g[h]=e(g[h],c);return g}if(null==a)return void alert("jQuery should be loaded before dmxServerAction.js");var f=a.dmxDataBindings;if(null==f)return void alert("HTML5 Data Bindings should be loaded before dmxServerAction.js");var g={FormData:void 0!==window.FormData};a.dmxServerAction=function(b){if(!(this instanceof a.dmxServerAction))return new a.dmxServerAction(b);d(b.id)||alert('Option "id" is required!'),d(b.url)||alert('Option "url" is required!'),a.dmxServerAction._[b.id]=this;var c=this,e=function(){c.send()};if(b.form&&b.sendOnSubmit!==!1){var g=a(b.form);b.method||(b.method=g[0].method),g.submit(function(a){a.preventDefault(),f.executer.runOnce(e)})}b.errorContainer&&a(b.errorContainer).hide(),b.sendOnReady&&a(document).ready(function(){f.executer.runOnce(e)}),b.sendOnLoad&&a(window).load(function(){f.executer.runOnce(e)}),a.isArray(b.sendOnDataChange)&&b.sendOnDataChange.length&&a(document).ready(function(){a.each(b.sendOnDataChange,function(c,d){a.each(b.data[d].match(/\{\{(.+?)\}\}/g),function(a,b){f.globalScope.watch(b,function(a,b){f.executer.runOnce(e)},null,!0)})})}),b.method||(b.method="POST"),this.state={},this.cfg=b,this._setState({executing:!1,uploading:!1,processing:!1,downloading:!1,lastError:!1,downloadProgress:{position:0,total:0,percent:0},uploadProgress:{position:0,total:0,percent:0},data:{}})},a.dmxServerAction._={},a.dmxServerAction.get=function(b){return a.dmxServerAction._[b]},a.dmxServerAction.prototype={_setState:function(b){f.setVariable(this.cfg.id,a.extend(this.state,b))},run:function(a,b){this.send(a,b)},send:function(d,f){var h=this,i=a.extend(!0,{},a.ajaxSettings,this.cfg,{data:d||{}});if(i.xhr=function(){var d=a.ajaxSettings.xhr();return d.upload&&d.upload.addEventListener("progress",function(a){var d=0,g=a.loaded||a.position,j=a.total;a.lengthComputable&&(d=Math.ceil(g/j*100)),h._setState({uploadProgress:{position:g,total:j,percent:d}}),100==d&&h._setState({uploading:!1,processing:!0,downloading:!1}),i.onUploadProgress&&c(e(i.onUploadProgress,b(f)),[g,j,d],h)}),d.addEventListener("progress",function(a){var d=0,g=a.loaded||a.position,j=a.total;a.lengthComputable&&(d=Math.ceil(g/j*100)),h._setState({uploading:!1,processing:!1,downloading:!0,downloadProgress:{position:g,total:j,percent:d}}),i.onProgress&&c(e(i.onProgress,b(f)),[g,j,d],h)}),d},i.form){var j=a(i.form),k=j.data("validator");if(k&&(k.resetForm(),k.settings.onsubmit&&!j.valid()))return;if(j.find("input[type=file]").length){if(!g.FormData)return void alert("Your browser doesn't support HTML5 File Uploads");var l=new FormData(j[0]);i.data&&!a.isEmptyObject(i.data)&&a.each(a.param(i.data).split("&"),function(a,b){var c=b.replace(/\+/g," ").split("=");l.append(decodeURIComponent(c[0]),decodeURIComponent(c[1]))}),i.data=l,i.method="POST",i.processData=!1,i.contentType=!1}else i.data=a.param(i.data),i.data+=(i.data?"&":"")+j.serialize()}if(c(e(i.onBeforeSend,b(f)),[e(i,b(f))],this)!==!1){a(i.errorContainer).empty().hide(),this._setState({executing:!0,uploading:!0,processing:!1,downloading:!1,downloadProgress:{position:0,total:0,percent:0},uploadProgress:{position:0,total:0,percent:0}});var m=a.ajax(e(i,b(f)));m.done(function(d){if(i.form){var g=a(i.form).data("validator");g&&g.resetForm()}h._setState({data:d}),setTimeout(function(){c(e(i.onSuccess,b(f)),[d],h)},0)}),m.fail(function(d,g,j){var k=d.responseText;if("DMXzone Server Connect"==d.getResponseHeader("X-Generator")&&400==d.status&&d.responseJSON&&d.responseJSON.data){k="<ul>";for(var l in d.responseJSON.data)k+="<li>"+l+": "+d.responseJSON.data[l]+"</li>";k+="</ul>"}h._setState({lastError:{status:d.status,response:k,responseText:d.responseText,responseJSON:d.responseJSON}}),setTimeout(function(){if(window.grecaptcha&&grecaptcha.reset(),400==d.status){if("DMXzone Server Connect"==d.getResponseHeader("X-Generator")){if(i.form&&d.responseJSON&&d.responseJSON.form&&c(e(i.onFormValidationError,b(f)),[k],h)!==!1){var l=a(i.form).data("validator");l&&l.showErrors(d.responseJSON.form)}d.responseJSON&&d.responseJSON.data&&(c(e(i.onDataValidationError,b(f)),[k],h),i.errorContainer&&a(i.errorContainer).html(k).show())}c(e(i.onValidationError,b(f)),[k],h)}else 401==d.status?c(e(i.onUnauthorized,b(f)),[k],h):403==d.status?c(e(i.onForbidden,b(f)),[k],h):(c(e(i.onError,b(f)),[k],h),i.errorContainer&&a(i.errorContainer).text(j?j:g).show())},0)}),m.always(function(){h._setState({executing:!1,uploading:!1,processing:!1,downloading:!1,downloadProgress:{position:0,total:0,percent:0},uploadProgress:{position:0,total:0,percent:0}}),setTimeout(function(){c(e(i.onComplete,b(f)),[],h)},0)}),this.jqxhr=m}},abort:function(){this.jqxhr&&this.jqxhr.abort&&this.jqxhr.abort()}}}(jQuery);